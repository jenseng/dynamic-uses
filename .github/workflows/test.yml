name: Test
on: workflow_call
jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.runner }}
    env:
      expected: |-
        here is some "text". this is not a newline: [\n]
        but this is on another line
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: YAML inputs
        uses: ./.
        id: yaml
        with:
          uses: ./.github/actions/echo
          with: |
            echo: ${{ toJSON(env.expected) }}
            ignored: whatever
      - uses: ./.github/actions/assert-equal
        with:
          expected: ${{ env.expected }}
          actual: ${{ fromJSON(steps.yaml.outputs.outputs).echo }}
      - name: JSON inputs
        uses: ./.
        id: json
        with:
          uses: ./.github/actions/echo
          with: |
            {
              "echo": ${{ toJSON(env.expected) }},
              "ignored": "whatever"
            }
      - uses: ./.github/actions/assert-equal
        with:
          expected: ${{ env.expected }}
          actual: ${{ fromJSON(steps.json.outputs.outputs).echo }}
      - name: No inputs
        uses: ./.
        id: no-inputs
        with:
          uses: ./.github/actions/echo
      - uses: ./.github/actions/assert-equal
        with:
          expected: ðŸ™Š
          actual: ${{ fromJSON(steps.no-inputs.outputs.outputs).echo }}
  test-invalid-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Attempt command substitution via uses
        id: command-substitution
        uses: ./.
        with:
          uses: ./.github/actions/echo$(echo secret>ohno.txt)
        continue-on-error: true
      - uses: ./.github/actions/assert-equal
        with:
          expected: failure
          actual: ${{ steps.command-substitution.outcome }}
      - id: verify-command-didnt-run
        shell: bash
        run: |
          if [ -f ohno.txt ]; then
            echo "::error::Expected command substitution not to happen"
            exit 1
          fi
      - name: Attempt expression injection
        uses: ./.
        id: expression-injection
        with:
          uses: ./.github/actions/echo
          with: |
            echo: ${{ '$' }}{{ env.expected }}
            ignored: whatever
      - uses: ./.github/actions/assert-equal
        with:
          expected: "${{ '$' }}{{ env.expected }}"
          actual: ${{ fromJSON(steps.expression-injection.outputs.outputs).echo }}
  