name: Test
on: workflow_call
jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.runner }}
    env:
      expected: |-
        here is some "text". this is not a newline: [\n]
        but this is on another line
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: YAML inputs
        uses: ./.
        id: yaml
        with:
          uses: ./.github/actions/echo
          with: |
            echo: ${{ toJSON(env.expected) }}
            ignored: whatever
      - uses: ./.github/actions/assert-equal
        with:
          expected: ${{ env.expected }}
          actual: ${{ fromJSON(steps.yaml.outputs.outputs).echo }}
      - name: JSON inputs
        uses: ./.
        id: json
        with:
          uses: ./.github/actions/echo
          with: |
            {
              "echo": ${{ toJSON(env.expected) }},
              "ignored": "whatever"
            }
      - uses: ./.github/actions/assert-equal
        with:
          expected: ${{ env.expected }}
          actual: ${{ fromJSON(steps.json.outputs.outputs).echo }}
      - name: No inputs
        uses: ./.
        id: no-inputs
        with:
          uses: ./.github/actions/echo
      - uses: ./.github/actions/assert-equal
        with:
          expected: ðŸ™Š
          actual: ${{ fromJSON(steps.no-inputs.outputs.outputs).echo }}
  test-invalid-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Attempt command substitution via uses
        id: command-substitution
        uses: ./.
        with:
          uses: ./.github/actions/echo$(echo secret>ohno.txt)
        continue-on-error: true
      - uses: ./.github/actions/assert-equal
        with:
          expected: failure
          actual: ${{ steps.command-substitution.outcome }}
      - id: verify-command-didnt-run
        shell: bash
        run: |
          if [ -f ohno.txt ]; then
            echo "::error::Expected command substitution not to happen"
            exit 1
          fi
      - name: Attempt expression injection
        uses: ./.
        id: expression-injection
        with:
          uses: ./.github/actions/echo
          with: |
            echo: ${{ '$' }}{{ env.expected }}
            ignored: whatever
      - uses: ./.github/actions/assert-equal
        with:
          expected: "${{ '$' }}{{ env.expected }}"
          actual: ${{ fromJSON(steps.expression-injection.outputs.outputs).echo }}
  test-env-outputs:
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Test env outputs
        uses: ./.
        with:
          uses: ./.github/actions/echo
          env-outputs: true
      - uses: ./.github/actions/assert-equal
        with:
          expected: abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
          actual: ${{ env.a_z }} # lowercased and underscored by dynamic-uses
      - name: Test env outputs with prefix
        uses: ./.
        with:
          uses: ./.github/actions/echo
          env-outputs-prefix: test_
      - uses: ./.github/actions/assert-equal
        with:
          expected: abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
          actual: ${{ env.test_a_z }}
      - name: Test env outputs with upcase
        uses: ./.
        with:
          uses: ./.github/actions/echo
          env-outputs-upcase: true
      - uses: ./.github/actions/assert-equal
        with:
          expected: abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
          actual: ${{ env.A_Z }}
      - name: Test env outputs with onconflict=overwrite
        uses: ./.
        env:
          overwrite_echo: uh-oh
        with:
          uses: ./.github/actions/echo
          env-outputs-onconflict: overwrite
          env-outputs-prefix: overwrite_
      - uses: ./.github/actions/assert-equal
        with:
          expected: ðŸ™Š
          actual: ${{ env.overwrite_echo }}
      - name: Test env outputs with onconflict=preserve
        uses: ./.
        env:
          preserve_echo: uh-oh
        with:
          uses: ./.github/actions/echo
          env-outputs-onconflict: preserve
          env-outputs-prefix: preserve_
      - uses: ./.github/actions/assert-equal
        with:
          expected: "" # blank, since it's preserved (it was only "uh-oh" within the step)
          actual: ${{ env.preserve_echo }}
      - name: Test env outputs with onconflict=error
        id: env-outputs-with-onconflict-error
        continue-on-error: true
        uses: ./.
        env:
          error_echo: uh-oh
        with:
          uses: ./.github/actions/echo
          env-outputs-onconflict: error
          env-outputs-prefix: error_
      - uses: ./.github/actions/assert-equal
        with:
          expected: failure
          actual: ${{ steps.env-outputs-with-onconflict-error.outcome }}
